function [u1d,u2d,u3d,u4d,u5d,markers] = skeletalDynamics(auxdata,t,q1,q2,q3,q4,q5,u1,u2,u3,u4,u5,TA,TK)
F1 = 0; F2 = 0; F3 = 0; F4 = 0; F5 = 0;
FR1 = 0; FR2 = 0; TR3 = 0;

npts = length(t);

% Unpack auxdata
g = auxdata.g;
r = auxdata.r;
IB = auxdata.IB;
IC = auxdata.IC;
ID = auxdata.ID;
LB = auxdata.LB;
LC = auxdata.LC;
LD = auxdata.LD;
mB = auxdata.mB;
mC = auxdata.mC;
mD = auxdata.mD;
mH = auxdata.mH;
rhoB = auxdata.rhoB;
rhoC = auxdata.rhoC;
rhoD = auxdata.rhoD;
HB = auxdata.HB;

% Sample ground reaction load splines
FG1 = ppval(auxdata.spline.GRFx,t);
FG2 = ppval(auxdata.spline.GRFy,t);
TG3 = ppval(auxdata.spline.GRTz,t);

% Initialize z matrix
z = zeros(npts,175);

% Evaluate constants
z(:,1) = cos(q1);
z(:,2) = sin(q1);
z(:,3) = cos(q2);
z(:,4) = sin(q2);
z(:,5) = cos(q3);
z(:,6) = sin(q3);
z(:,7) = z(:,3).*z(:,5) + z(:,4).*z(:,6);
z(:,8) = z(:,4).*z(:,5) - z(:,3).*z(:,6);
z(:,9) = z(:,3).*z(:,6) - z(:,4).*z(:,5);
z(:,10) = z(:,1).*z(:,7) + z(:,2).*z(:,8);
z(:,11) = z(:,1).*z(:,8) - z(:,2).*z(:,7);
z(:,12) = z(:,1).*z(:,9) + z(:,2).*z(:,7);
z(:,13) = z(:,1).*z(:,7) - z(:,2).*z(:,9);
z(:,14) = rhoD - LD;
z(:,15) = rhoC - LC;
z(:,16) = LD.*z(:,3);
z(:,17) = LD.*z(:,4);
z(:,18) = z(:,16) - z(:,15);
z(:,19) = LC + z(:,16);
z(:,20) = z(:,17) - r;
z(:,21) = r + z(:,17);
z(:,22) = LB - rhoB;
z(:,23) = 0.25.*rhoB - HB;
z(:,24) = z(:,1).*z(:,19) + z(:,2).*z(:,17);
z(:,25) = LC.*z(:,1);
z(:,26) = z(:,1).*z(:,17) - z(:,2).*z(:,19);
z(:,27) = LC.*z(:,2);
z(:,28) = z(:,24) - z(:,23);
z(:,29) = z(:,23) - z(:,25);
z(:,30) = z(:,22) + z(:,26);
z(:,31) = z(:,27) - z(:,22);
z(:,32) = HB + z(:,24);
z(:,33) = -HB - z(:,25);
z(:,34) = LB + z(:,26);
z(:,35) = z(:,27) - LB;
z(:,36) = z(:,26) - r;
z(:,37) = r + z(:,27);
z(:,38) = r + z(:,26);
z(:,39) = z(:,27) - r;
z(:,40) = u3 - u2;
z(:,41) = u1 + u3 - u2;
z(:,42) = z(:,5).*u4 + z(:,6).*u5 - z(:,14).*u3;
z(:,43) = z(:,5).*u5 - z(:,6).*u4;
z(:,44) = u3.*(z(:,5).*u5-z(:,6).*u4);
z(:,45) = u3.*(z(:,5).*u4+z(:,6).*u5);
z(:,46) = z(:,44) - u3.*z(:,43);
z(:,47) = u3.*z(:,42) - z(:,45);
z(:,48) = z(:,15).*u2 + z(:,7).*u4 + z(:,9).*u5 + z(:,18).*u3;
z(:,49) = z(:,7).*u5 + z(:,8).*u4 + z(:,17).*u3;
z(:,50) = z(:,3).*z(:,6).*u2 + z(:,4).*z(:,5).*u3 - z(:,3).*z(:,6).*u3 - z(:,4).*z(:,5).*u2;
z(:,51) = z(:,3).*z(:,5).*u3 + z(:,4).*z(:,6).*u3 - z(:,3).*z(:,5).*u2 - z(:,4).*z(:,6).*u2;
z(:,52) = LD.*z(:,4).*u2;
z(:,53) = u4.*z(:,50) + u5.*z(:,51) - u3.*z(:,52);
z(:,54) = z(:,3).*z(:,5).*u2 + z(:,4).*z(:,6).*u2 - z(:,3).*z(:,5).*u3 - z(:,4).*z(:,6).*u3;
z(:,55) = LD.*z(:,3).*u2;
z(:,56) = u3.*z(:,55) + u4.*z(:,54) + u5.*z(:,50);
z(:,57) = z(:,53) - z(:,40).*z(:,49);
z(:,58) = z(:,56) + z(:,40).*z(:,48);
z(:,59) = z(:,10).*u4 + z(:,12).*u5 + z(:,28).*u3 + z(:,29).*u2 - z(:,23).*u1;
z(:,60) = z(:,22).*u1 + z(:,11).*u4 + z(:,13).*u5 + z(:,30).*u3 + z(:,31).*u2;
z(:,61) = z(:,1).*z(:,8).*u1 + z(:,1).*z(:,50) + z(:,2).*z(:,54) - z(:,2).*z(:,7).*u1;
z(:,62) = z(:,1).*z(:,7).*u1 + z(:,1).*z(:,51) + z(:,2).*z(:,50) - z(:,2).*z(:,9).*u1;
z(:,63) = z(:,1).*z(:,17).*u1 + z(:,2).*z(:,55) - z(:,2).*z(:,19).*u1 - z(:,1).*z(:,52);
z(:,64) = LC.*z(:,2).*u1;
z(:,65) = u2.*z(:,64) + u3.*z(:,63) + u4.*z(:,61) + u5.*z(:,62);
z(:,66) = z(:,1).*z(:,54) - z(:,1).*z(:,7).*u1 - z(:,2).*z(:,8).*u1 - z(:,2).*z(:,50);
z(:,67) = z(:,1).*z(:,50) - z(:,1).*z(:,9).*u1 - z(:,2).*z(:,7).*u1 - z(:,2).*z(:,51);
z(:,68) = z(:,1).*z(:,55) + z(:,2).*z(:,52) - z(:,1).*z(:,19).*u1 - z(:,2).*z(:,17).*u1;
z(:,69) = LC.*z(:,1).*u1;
z(:,70) = u2.*z(:,69) + u3.*z(:,68) + u4.*z(:,66) + u5.*z(:,67);
z(:,71) = z(:,65) - z(:,41).*z(:,60);
z(:,72) = z(:,70) + z(:,41).*z(:,59);
z(:,73) = -LC - z(:,15);
z(:,74) = -LD - z(:,14);
z(:,75) = r.^2 + z(:,73).^2;
z(:,76) = r.*z(:,73);
z(:,77) = z(:,75) - 2.*z(:,76).*z(:,2);
z(:,78) = z(:,77).^0.5;
z(:,79) = r./z(:,78);
z(:,80) = z(:,73)./z(:,78);
z(:,81) = z(:,75) + 2.*z(:,76).*z(:,2);
z(:,82) = z(:,81).^0.5;
z(:,83) = r./z(:,82);
z(:,84) = z(:,73)./z(:,82);
z(:,85) = r.^2 + z(:,74).^2;
z(:,86) = r.*z(:,74);
z(:,87) = z(:,85) + 2.*z(:,86).*z(:,4);
z(:,88) = z(:,87).^0.5;
z(:,89) = r./z(:,88);
z(:,90) = z(:,74)./z(:,88);
z(:,91) = z(:,85) - 2.*z(:,86).*z(:,4);
z(:,92) = z(:,91).^0.5;
z(:,93) = r./z(:,92);
z(:,94) = z(:,74)./z(:,92);
z(:,95) = z(:,1).*z(:,3) + z(:,2).*z(:,4);
z(:,96) = z(:,2).*z(:,3) - z(:,1).*z(:,4);
z(:,98) = LC.^2 + r.^2 + z(:,74).^2;
z(:,99) = LC.*r;
z(:,100) = LC.*z(:,74);
z(:,101) = z(:,98) + 2.*z(:,99).*z(:,2) - 2.*z(:,86).*z(:,96) - 2.*z(:,100).*z(:,3);
z(:,102) = z(:,101).^0.5;
z(:,103) = r./z(:,102);
z(:,104) = LC./z(:,102);
z(:,105) = z(:,74)./z(:,102);
z(:,106) = g.*mB;
z(:,107) = g.*mC;
z(:,108) = g.*mD;
z(:,109) = g.*mH;
z(:,110) = FR2 - z(:,109);
z(:,111) = q5 + LB.*z(:,12) - HB.*z(:,13) - LC.*z(:,7) - LD.*z(:,5);
z(:,112) = HB.*z(:,11) + LC.*z(:,8) - q4 - LB.*z(:,10) - LD.*z(:,6);
z(:,113) = z(:,111) + HB.*z(:,10) + LB.*z(:,11);
z(:,114) = z(:,112) + HB.*z(:,12) + LB.*z(:,13);
z(:,115) = r.*(z(:,1).*z(:,104)-z(:,95).*z(:,105));
z(:,116) = r.*z(:,1).*z(:,80);
z(:,117) = r.*z(:,1).*z(:,84);
z(:,118) = z(:,106).*(z(:,22).*z(:,13)-z(:,23).*z(:,12));
z(:,119) = z(:,10).*z(:,33) + z(:,11).*z(:,35) - z(:,111);
z(:,120) = z(:,12).*z(:,33) + z(:,13).*z(:,35) - z(:,112);
z(:,121) = z(:,2).*z(:,25).*z(:,80) - z(:,25).*z(:,79) - z(:,15).*z(:,1).*z(:,79) - z(:,1).*z(:,37).*z(:,80);
z(:,122) = z(:,25).*z(:,83) + z(:,15).*z(:,1).*z(:,83) + z(:,2).*z(:,25).*z(:,84) - z(:,1).*z(:,39).*z(:,84);
z(:,123) = z(:,1).*z(:,37).*z(:,104) + z(:,25).*z(:,96).*z(:,105) - z(:,25).*z(:,103) - z(:,2).*z(:,25).*z(:,104) - z(:,37).*z(:,95).*z(:,105);
z(:,124) = r.*z(:,3).*z(:,90);
z(:,125) = r.*z(:,3).*z(:,94);
z(:,126) = z(:,15).*z(:,107);
z(:,127) = -z(:,126).*z(:,9) - z(:,106).*(z(:,12).*z(:,29)+z(:,13).*z(:,31));
z(:,128) = z(:,111) + z(:,10).*z(:,32) + z(:,11).*z(:,34);
z(:,129) = z(:,112) + z(:,12).*z(:,32) + z(:,13).*z(:,34);
z(:,130) = z(:,17).*z(:,80) + z(:,24).*z(:,79) - z(:,1).*z(:,18).*z(:,79) - z(:,1).*z(:,36).*z(:,80) - z(:,2).*z(:,17).*z(:,79) - z(:,2).*z(:,24).*z(:,80);
z(:,131) = z(:,17).*z(:,84) + z(:,1).*z(:,18).*z(:,83) + z(:,2).*z(:,17).*z(:,83) - z(:,24).*z(:,83) - z(:,1).*z(:,38).*z(:,84) - z(:,2).*z(:,24).*z(:,84);
z(:,132) = z(:,24).*z(:,103) + z(:,1).*z(:,36).*z(:,104) + z(:,2).*z(:,24).*z(:,104) + z(:,14).*(z(:,4).*z(:,104)+z(:,95).*z(:,103)) - z(:,24).*z(:,96).*z(:,105) - z(:,36).*z(:,95).*z(:,105);
z(:,133) = z(:,16).*z(:,89) + z(:,14).*z(:,3).*z(:,89) + z(:,4).*z(:,16).*z(:,90) - z(:,3).*z(:,20).*z(:,90);
z(:,134) = z(:,4).*z(:,16).*z(:,94) - z(:,16).*z(:,93) - z(:,14).*z(:,3).*z(:,93) - z(:,3).*z(:,21).*z(:,94);
z(:,135) = z(:,14).*z(:,108);
z(:,136) = TR3 + z(:,135).*z(:,6) - z(:,107).*z(:,7).*z(:,17) - z(:,107).*z(:,9).*z(:,18) - z(:,106).*(z(:,12).*z(:,28)+z(:,13).*z(:,30));
z(:,137) = z(:,8).*z(:,80) + z(:,10).*z(:,79) - z(:,1).*z(:,7).*z(:,79) - z(:,1).*z(:,11).*z(:,80) - z(:,2).*z(:,8).*z(:,79) - z(:,2).*z(:,10).*z(:,80);
z(:,138) = z(:,8).*z(:,84) + z(:,1).*z(:,7).*z(:,83) + z(:,2).*z(:,8).*z(:,83) - z(:,10).*z(:,83) - z(:,1).*z(:,11).*z(:,84) - z(:,2).*z(:,10).*z(:,84);
z(:,139) = z(:,10).*z(:,103) + z(:,1).*z(:,11).*z(:,104) + z(:,2).*z(:,10).*z(:,104) + z(:,3).*z(:,6).*z(:,104) + z(:,6).*z(:,96).*z(:,103) - z(:,6).*z(:,105) - z(:,4).*z(:,5).*z(:,104) - z(:,5).*z(:,95).*z(:,103) - z(:,10).*z(:,96).*z(:,105) - z(:,11).*z(:,95).*z(:,105);
z(:,140) = z(:,7).*z(:,89) + z(:,4).*z(:,7).*z(:,90) - z(:,6).*z(:,90) - z(:,3).*z(:,5).*z(:,89) - z(:,3).*z(:,8).*z(:,90) - z(:,4).*z(:,6).*z(:,89);
z(:,141) = z(:,3).*z(:,5).*z(:,93) + z(:,4).*z(:,6).*z(:,93) + z(:,4).*z(:,7).*z(:,94) - z(:,6).*z(:,94) - z(:,7).*z(:,93) - z(:,3).*z(:,8).*z(:,94);
z(:,142) = z(:,10).^2 + z(:,11).^2;
z(:,143) = z(:,10).*z(:,12) + z(:,11).*z(:,13);
z(:,144) = FR1 - z(:,107).*z(:,7).*z(:,8) - z(:,107).*z(:,7).*z(:,9) - z(:,106).*(z(:,10).*z(:,12)+z(:,11).*z(:,13));
z(:,145) = z(:,7).*z(:,80) + z(:,12).*z(:,79) - z(:,1).*z(:,9).*z(:,79) - z(:,1).*z(:,13).*z(:,80) - z(:,2).*z(:,7).*z(:,79) - z(:,2).*z(:,12).*z(:,80);
z(:,146) = z(:,7).*z(:,84) + z(:,1).*z(:,9).*z(:,83) + z(:,2).*z(:,7).*z(:,83) - z(:,12).*z(:,83) - z(:,1).*z(:,13).*z(:,84) - z(:,2).*z(:,12).*z(:,84);
z(:,147) = z(:,5).*z(:,90) + z(:,9).*z(:,89) + z(:,4).*z(:,5).*z(:,89) + z(:,4).*z(:,9).*z(:,90) - z(:,3).*z(:,6).*z(:,89) - z(:,3).*z(:,7).*z(:,90);
z(:,148) = z(:,5).*z(:,94) + z(:,3).*z(:,6).*z(:,93) + z(:,4).*z(:,9).*z(:,94) - z(:,9).*z(:,93) - z(:,3).*z(:,7).*z(:,94) - z(:,4).*z(:,5).*z(:,93);
z(:,149) = z(:,5).*z(:,105) + z(:,12).*z(:,103) + z(:,1).*z(:,13).*z(:,104) + z(:,2).*z(:,12).*z(:,104) - z(:,3).*z(:,5).*z(:,104) - z(:,4).*z(:,6).*z(:,104) - z(:,5).*z(:,96).*z(:,103) - z(:,6).*z(:,95).*z(:,103) - z(:,12).*z(:,96).*z(:,105) - z(:,13).*z(:,95).*z(:,105);
z(:,150) = z(:,12).^2 + z(:,13).^2;
z(:,151) = z(:,110) - z(:,107).*z(:,7).^2 - z(:,107).*z(:,9).^2 - z(:,108).*z(:,5).^2 - z(:,108).*z(:,6).^2 - z(:,106).*(z(:,12).^2+z(:,13).^2);
z(:,152) = mB.*(z(:,22).*z(:,31)-z(:,23).*z(:,29)) - IB;
z(:,153) = IB + mB.*(z(:,22).^2+z(:,23).^2);
z(:,154) = IB + mB.*(z(:,22).*z(:,30)-z(:,23).*z(:,28));
z(:,155) = mB.*(z(:,22).*z(:,11)-z(:,23).*z(:,10));
z(:,156) = mB.*(z(:,22).*z(:,13)-z(:,23).*z(:,12));
z(:,157) = mB.*(z(:,22).*z(:,72)-z(:,23).*z(:,71));
z(:,158) = IB + IC + mC.*z(:,15).^2;
z(:,159) = z(:,158) + mB.*(z(:,29).^2+z(:,31).^2);
z(:,160) = mC.*z(:,15);
z(:,161) = z(:,160).*z(:,18) + mB.*(z(:,28).*z(:,29)+z(:,30).*z(:,31)) - IB - IC;
z(:,162) = z(:,160).*z(:,7) + mB.*(z(:,10).*z(:,29)+z(:,11).*z(:,31));
z(:,163) = z(:,160).*z(:,9) + mB.*(z(:,12).*z(:,29)+z(:,13).*z(:,31));
z(:,164) = z(:,160).*z(:,57) + mB.*(z(:,29).*z(:,71)+z(:,31).*z(:,72));
z(:,165) = IB + IC + ID + mD.*z(:,14).^2;
z(:,166) = z(:,165) + mB.*(z(:,28).^2+z(:,30).^2) + mC.*(z(:,17).^2+z(:,18).^2);
z(:,167) = mD.*z(:,14);
z(:,168) = mB.*(z(:,10).*z(:,28)+z(:,11).*z(:,30)) + mC.*(z(:,7).*z(:,18)+z(:,8).*z(:,17)) - z(:,167).*z(:,5);
z(:,169) = mB.*(z(:,12).*z(:,28)+z(:,13).*z(:,30)) + mC.*(z(:,7).*z(:,17)+z(:,9).*z(:,18)) - z(:,167).*z(:,6);
z(:,170) = mB.*(z(:,28).*z(:,71)+z(:,30).*z(:,72)) + mC.*(z(:,17).*z(:,58)+z(:,18).*z(:,57)) - z(:,167).*z(:,46);
z(:,171) = mH + mB.*(z(:,10).^2+z(:,11).^2) + mC.*(z(:,7).^2+z(:,8).^2) + mD.*(z(:,5).^2+z(:,6).^2);
z(:,172) = mC.*z(:,7).*(z(:,8)+z(:,9)) + mB.*(z(:,10).*z(:,12)+z(:,11).*z(:,13));
z(:,173) = mB.*(z(:,10).*z(:,71)+z(:,11).*z(:,72)) + mC.*(z(:,7).*z(:,57)+z(:,8).*z(:,58)) + mD.*(z(:,5).*z(:,46)-z(:,6).*z(:,47));
z(:,174) = mH + mB.*(z(:,12).^2+z(:,13).^2) + mC.*(z(:,7).^2+z(:,9).^2) + mD.*(z(:,5).^2+z(:,6).^2);
z(:,175) = mB.*(z(:,12).*z(:,71)+z(:,13).*z(:,72)) + mC.*(z(:,7).*z(:,58)+z(:,9).*z(:,57)) + mD.*(z(:,5).*z(:,47)+z(:,6).*z(:,46));


% Construct mass matrix and right hand side
Amat11 = z(:,153);
Amat12 = z(:,152);
Amat13 = z(:,154);
Amat14 = z(:,155);
Amat15 = z(:,156);
Amat21 = z(:,152);
Amat22 = z(:,159);
Amat23 = z(:,161);
Amat24 = z(:,162);
Amat25 = z(:,163);
Amat31 = z(:,154);
Amat32 = z(:,161);
Amat33 = z(:,166);
Amat34 = z(:,168);
Amat35 = z(:,169);
Amat41 = z(:,155);
Amat42 = z(:,162);
Amat43 = z(:,168);
Amat44 = z(:,171);
Amat45 = z(:,172);
Amat51 = z(:,156);
Amat52 = z(:,163);
Amat53 = z(:,169);
Amat54 = z(:,172);
Amat55 = z(:,174);
bvec1 = TG3 + F1.*z(:,116) + FG1.*z(:,113) + FG2.*z(:,114) - TA - z(:,118) - F2.*z(:,117) - F5.*z(:,115) - z(:,157);
bvec2 = z(:,127) + F1.*z(:,121) + F2.*z(:,122) + F4.*z(:,125) + F5.*z(:,123) + FG1.*z(:,119) + FG2.*z(:,120) - TG3 - TK - F3.*z(:,124) - z(:,164);
bvec3 = TG3 + z(:,136) + F1.*z(:,130) + F2.*z(:,131) + F3.*z(:,133) + F4.*z(:,134) + F5.*z(:,132) + FG1.*z(:,128) + FG2.*z(:,129) - z(:,170);
bvec4 = z(:,144) + F1.*z(:,137) + F2.*z(:,138) + F3.*z(:,140) + F4.*z(:,141) + F5.*z(:,139) + FG1.*z(:,142) + FG2.*z(:,143) - z(:,173);
bvec5 = z(:,151) + F1.*z(:,145) + F2.*z(:,146) + F3.*z(:,147) + F4.*z(:,148) + F5.*z(:,149) + FG1.*z(:,143) + FG2.*z(:,150) - z(:,175);

% Calculate accelerations
ud = zeros(npts,5);
for i = 1:npts
    Amat = [Amat11(i),Amat12(i),Amat13(i),Amat14(i),Amat15(i);
        Amat21(i),Amat22(i),Amat23(i),Amat24(i),Amat25(i);
        Amat31(i),Amat32(i),Amat33(i),Amat34(i),Amat35(i);
        Amat41(i),Amat42(i),Amat43(i),Amat44(i),Amat45(i);
        Amat51(i),Amat52(i),Amat53(i),Amat54(i),Amat55(i)];
    bvec = [bvec1(i);bvec2(i);bvec3(i);bvec4(i);bvec5(i)];
    ud(i,:) = (Amat\bvec)';
end
u1d = ud(:,1);
u2d = ud(:,2);
u3d = ud(:,3);
u4d = ud(:,4);
u5d = ud(:,5);


% Calculate marker positions
markers = auxdata.markers;
px1 = markers.px1; % Relative to A in B coord sys
py1 = markers.py1;
px2 = markers.px2;
py2 = markers.py2;
px3 = markers.px3; % Relative to K in C coord sys
py3 = markers.py3;
px4 = markers.px4;
py4 = markers.py4;
px5 = markers.px5; % Relative to H in D coord sys
py5 = markers.py5;
px6 = markers.px6;
py6 = markers.py6;

markers.xB1 = q4 + LD.*z(:,6) + px1.*z(:,10) + py1.*z(:,11) - LC.*z(:,8);
markers.yB1 = q5 + px1.*z(:,12) + py1.*z(:,13) - LC.*z(:,7) - LD.*z(:,5);
markers.xB2 = q4 + LD.*z(:,6) + px2.*z(:,10) + py2.*z(:,11) - LC.*z(:,8);
markers.yB2 = q5 + px2.*z(:,12) + py2.*z(:,13) - LC.*z(:,7) - LD.*z(:,5);
markers.xC1 = q4 + LD.*z(:,6) + px3.*z(:,7) + py3.*z(:,8);
markers.yC1 = q5 + px3.*z(:,9) + py3.*z(:,7) - LD.*z(:,5);
markers.xC2 = q4 + LD.*z(:,6) + px4.*z(:,7) + py4.*z(:,8);
markers.yC2 = q5 + px4.*z(:,9) + py4.*z(:,7) - LD.*z(:,5);
markers.xD1 = q4 + px5.*z(:,5) - py5.*z(:,6);
markers.yD1 = q5 + px5.*z(:,6) + py5.*z(:,5);
markers.xD2 = q4 + px6.*z(:,5) - py6.*z(:,6);
markers.yD2 = q5 + px6.*z(:,6) + py6.*z(:,5);


end